{% extends 'base.html' %}
{% load static %}

{% block title %}Admin Dashboard - Cookie Craze{% endblock %}

{% block content %}
<div class="content">
    <!-- Header with welcome, date/time, and profile menu -->
    <div class="unified-page-header d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div>
            <h1 class="unified-h1 mb-1">Welcome, Admin</h1>
            <p class="unified-subtitle mb-1">Complete overview of Cookie Craze performance</p>
            <div class="text-muted" style="font-size: 0.9rem;">
                <i class="fas fa-calendar-alt me-1"></i>
                <span id="admin-current-date">{{ today|date:"F j, Y" }}</span>
                •
                <i class="fas fa-clock ms-1 me-1"></i>
                <span id="admin-current-time">--:--:--</span>
            </div>
        </div>
        <div class="d-flex align-items-center gap-2">
            <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="adminProfileMenu" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-user-shield me-1"></i> {{ request.user.username }}
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="adminProfileMenu">
                    <li><a class="dropdown-item" href="{% url 'staff_profile' %}"><i class="fas fa-user-cog me-2"></i>Account Settings</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="{% url 'logout' %}" onclick="return showLogoutModal(event)" data-no-loading><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Summary cards -->
    <div class="row g-4 mb-4">
        <div class="col-md-4 col-lg-2">
            <div class="unified-card text-center h-100">
                <div class="card-icon success">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <h3 class="card-value">₱{{ total_revenue_today|floatformat:2 }}</h3>
                <p class="card-label">Total Sales Today</p>
            </div>
        </div>
        <div class="col-md-4 col-lg-2">
            <div class="unified-card text-center h-100">
                <div class="card-icon primary">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <h3 class="card-value">{{ total_orders_today }}</h3>
                <p class="card-label">Total Orders Today</p>
            </div>
        </div>
        <div class="col-md-4 col-lg-2">
            <div class="unified-card text-center h-100">
                <div class="card-icon info">
                    <i class="fas fa-mobile-alt"></i>
                </div>
                <h3 class="card-value">{{ gcash_transactions_today }}</h3>
                <p class="card-label">GCash Transactions</p>
            </div>
        </div>
        <div class="col-md-4 col-lg-2">
            <div class="unified-card text-center h-100">
                <div class="card-icon warning">
                    <i class="fas fa-coins"></i>
                </div>
                <h3 class="card-value">{{ cash_transactions_today }}</h3>
                <p class="card-label">Cash Transactions</p>
            </div>
        </div>
        <div class="col-md-4 col-lg-2">
            <div class="unified-card text-center h-100">
                <div class="card-icon warning">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h3 class="card-value">{{ low_stock_count }}</h3>
                <p class="card-label">Low Stock Items</p>
            </div>
        </div>
        <div class="col-md-4 col-lg-2">
            <div class="unified-card text-center h-100">
                <div class="card-icon info">
                    <i class="fas fa-users"></i>
                </div>
                <h3 class="card-value">{{ total_staff }}</h3>
                <p class="card-label">Active Staff</p>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="mb-4">
        <div class="d-flex flex-wrap gap-2">
            <a href="{% url 'record_sale' %}" class="unified-btn unified-btn-primary"><i class="fas fa-plus-circle me-1"></i>New Order</a>
            <a href="{% url 'order_management' %}" class="unified-btn unified-btn-primary"><i class="fas fa-list me-1"></i>Manage Orders</a>
            <a href="{% url 'inventory' %}" class="unified-btn unified-btn-secondary"><i class="fas fa-boxes me-1"></i>Manage Inventory</a>
            <a href="{% url 'add_cookie' %}" class="unified-btn unified-btn-secondary"><i class="fas fa-plus me-1"></i>Add Product</a>
            <a href="{% url 'staff_management' %}" class="unified-btn unified-btn-secondary"><i class="fas fa-user-friends me-1"></i>Staff Accounts</a>
            <a href="{% url 'daily_sales_report' %}" class="unified-btn unified-btn-secondary"><i class="fas fa-chart-line me-1"></i>Sales Reports</a>
            <a href="{% url 'activity_logs' %}" class="unified-btn unified-btn-secondary"><i class="fas fa-clipboard-list me-1"></i>System Activity</a>
        </div>
    </div>

    <!-- Sales Overview with charts -->
    <div class="row g-4 mb-4">
        <div class="col-lg-8">
            <div class="unified-card h-100">
                <h2 class="unified-h2 mb-2"><i class="fas fa-chart-bar me-2"></i>Sales Overview (Last 7 Days)</h2>
                {% if daily_sales_values %}
                <canvas id="dailySalesChart" height="140"></canvas>
                {% else %}
                <div class="text-center py-5 text-muted">
                    <i class="fas fa-chart-bar fa-3x mb-2 opacity-50"></i>
                    <p>No sales data available for the last 7 days.</p>
                </div>
                {% endif %}
            </div>
        </div>
        <div class="col-lg-4">
            <div class="unified-card h-100">
                <h2 class="unified-h2 mb-2"><i class="fas fa-chart-pie me-2"></i>Payment Methods Today</h2>
                {% if payment_values %}
                <canvas id="paymentMethodChart" height="180"></canvas>
                {% else %}
                <div class="text-center py-5 text-muted">
                    <i class="fas fa-chart-pie fa-3x mb-2 opacity-50"></i>
                    <p>No transactions today.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Latest Orders and Inventory/Staff panels -->
    <div class="row g-4 mb-4">
        <!-- Latest Orders Table -->
        <div class="col-lg-8">
            <div class="unified-card h-100">
                <h2 class="unified-h2 mb-2"><i class="fas fa-receipt me-2"></i>Latest Orders</h2>
                <div class="unified-table-container" style="font-size: var(--text-sm);">
                    <table class="unified-table">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Customer</th>
                                <th>Staff</th>
                                <th class="text-end">Total</th>
                                <th>Payment</th>
                                <th>Status</th>
                                <th>Time</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for o in latest_orders %}
                            <tr>
                                <td class="fw-semibold">{{ o.order_id }}</td>
                                <td>{{ o.customer_name|default:'Walk-in' }}</td>
                                <td>{{ o.staff.username|default:'—' }}</td>
                                <td class="text-end">₱{{ o.total_amount|floatformat:2 }}</td>
                                <td class="text-capitalize">{{ o.payment_method }}</td>
                                <td>
                                    <span class="badge {% if o.status == 'completed' %}bg-success{% elif o.status == 'pending' %}bg-warning text-dark{% elif o.status == 'ready' %}bg-info text-dark{% else %}bg-secondary{% endif %}">{{ o.get_status_display }}</span>
                                </td>
                                <td>{{ o.created_at|date:"h:i A" }}</td>
                                <td class="text-end">
                                    <a href="{% url 'order_detail' o.id %}" class="unified-btn unified-btn-sm unified-btn-secondary"><i class="fas fa-eye"></i></a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="8" class="text-center py-4 text-muted">No orders found for today.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Inventory Status & Staff Activity -->
        <div class="col-lg-4">
            <div class="unified-card mb-3">
                <h2 class="unified-h2 mb-2"><i class="fas fa-box-open me-2"></i>Inventory Status</h2>
                <p class="mb-1"><strong>Total Items:</strong> {{ total_cookies }} ({{ total_cookie_types }} types)</p>
                <p class="mb-1"><strong>Active Items:</strong> {{ active_cookies }} ({{ active_items_percentage|floatformat:1 }}%)</p>
                <p class="mb-1"><strong>Low Stock:</strong> {{ low_stock_count }} • <strong>Out of Stock:</strong> {{ out_of_stock_count }}</p>
                <a href="{% url 'inventory' %}" class="unified-btn unified-btn-sm unified-btn-primary mt-2"><i class="fas fa-boxes me-1"></i>Go to Inventory</a>
            </div>

            <div class="unified-card">
                <h2 class="unified-h2 mb-2"><i class="fas fa-user-tie me-2"></i>Staff Activity</h2>
                {% if staff_performance %}
                <div class="space-y-2">
                    {% for staff in staff_performance %}
                    <div class="unified-card-sm">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="fw-semibold mb-1">{{ staff.user.username }}</h6>
                                <small class="text-muted">{{ staff.staff_id }} • {{ staff.get_role_display }}</small>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold text-success">₱{{ staff.total_completed_revenue|default:0|floatformat:2 }}</div>
                                <small class="text-muted">{{ staff.total_completed_sales|default:0 }} orders</small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted mb-0">No staff activity yet today.</p>
                {% endif %}
                <a href="{% url 'staff_management' %}" class="unified-btn unified-btn-sm unified-btn-secondary mt-3"><i class="fas fa-users-cog me-1"></i>Manage Staff</a>
            </div>
        </div>
    </div>

    <!-- Pending Approvals, Notifications, and System Logs -->
    <div class="row g-4">
        <!-- Pending Approvals -->
        <div class="col-lg-6">
            <div class="unified-card h-100">
                <h2 class="unified-h2 mb-2"><i class="fas fa-clipboard-check me-2"></i>Pending Approvals</h2>
                {% if pending_gcash_orders or pending_staff_count %}
                <div class="unified-table-container" style="font-size: var(--text-sm);">
                    <table class="unified-table">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Reference</th>
                                <th>Submitted By</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in pending_gcash_orders %}
                            <tr>
                                <td><span class="badge bg-info text-dark">GCash Verification</span></td>
                                <td>{{ order.order_id }} / {{ order.gcash_reference|default:order.hex_id }}</td>
                                <td>{{ order.staff.username|default:'—' }}</td>
                                <td class="text-end">
                                    <a href="{% url 'verify_gcash' order.id %}" class="unified-btn unified-btn-sm unified-btn-primary">Review</a>
                                </td>
                            </tr>
                            {% endfor %}
                            {% if pending_staff_count %}
                            <tr>
                                <td><span class="badge bg-warning text-dark">Staff Approval</span></td>
                                <td>{{ pending_staff_count }} pending staff member(s)</td>
                                <td>Admin Queue</td>
                                <td class="text-end">
                                    <a href="{% url 'staff_management' %}" class="unified-btn unified-btn-sm unified-btn-secondary">Review</a>
                                </td>
                            </tr>
                            {% endif %}
                            {% if not pending_gcash_orders and not pending_staff_count %}
                            <tr>
                                <td colspan="4" class="text-center py-3 text-muted">No pending approvals.</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5 text-muted">
                    <i class="fas fa-check-circle fa-3x mb-2 opacity-50"></i>
                    <p>All approvals are current. No pending items.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Notifications & System Logs -->
        <div class="col-lg-3">
            <div class="unified-card h-100">
                <h2 class="unified-h2 mb-2"><i class="fas fa-bell me-2"></i>Notifications</h2>
                {% if admin_notifications %}
                <div class="list-group list-group-flush">
                    {% for n in admin_notifications %}
                    <div class="list-group-item d-flex align-items-start">
                        <div class="me-2"><i class="{{ n.icon }}" style="width:16px"></i></div>
                        <div>
                            <div class="fw-semibold">{{ n.title }}</div>
                            <div class="text-muted" style="font-size: var(--text-sm);">{{ n.message }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-5 text-muted">
                    <i class="fas fa-bell-slash fa-2x mb-2 opacity-50"></i>
                    <p style="font-size: var(--text-sm);">No alerts at this time.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="col-lg-3">
            <div class="unified-card h-100">
                <h2 class="unified-h2 mb-2"><i class="fas fa-stream me-2"></i>System Logs</h2>
                {% if recent_activity_logs %}
                <ul class="list-unstyled mb-0" style="font-size: var(--text-sm);">
                    {% for log in recent_activity_logs %}
                    <li class="mb-2 pb-2" style="border-bottom: 1px solid var(--border);">
                        <div class="fw-semibold">{{ log.get_action_display }}</div>
                        <div class="text-muted" style="font-size: var(--text-xs);">{{ log.timestamp|date:"M d, Y h:i A" }} • {{ log.user.username|default:'System' }}</div>
                        <div class="text-muted" style="font-size: var(--text-xs);">{{ log.description|truncatechars:60 }}</div>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <div class="text-center py-5 text-muted">
                    <i class="fas fa-history fa-2x mb-2 opacity-50"></i>
                    <p style="font-size: var(--text-sm);">No recent activity.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
.card-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1rem;
    font-size: 1.5rem;
}

.card-icon.success { background: rgba(40, 167, 69, 0.1); color: var(--success); }
.card-icon.primary { background: rgba(139, 69, 19, 0.1); color: var(--primary); }
.card-icon.info { background: rgba(13, 110, 253, 0.1); color: var(--info); }
.card-icon.warning { background: rgba(255, 193, 7, 0.1); color: var(--warning); }
.card-icon.purple { background: rgba(111, 66, 193, 0.1); color: #6f42c1; }

.card-value {
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    color: var(--text-primary);
}

.card-label {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
}

.badge {
    font-size: 0.7rem;
    font-weight: 600;
}

.unified-table th {
    background: var(--bg-tertiary);
    font-weight: 600;
    color: var(--text-primary);
    border-bottom: 2px solid var(--border);
}

.unified-table td {
    padding: 0.75rem;
    vertical-align: middle;
}

.unified-card-sm {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: var(--space-md);
    margin-bottom: var(--space-sm);
}

.bg-purple {
    background-color: #6f42c1 !important;
}

.space-y-2 > * + * {
    margin-top: var(--space-sm);
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .card-value {
        font-size: 1.5rem;
    }
    
    .unified-table-container {
        font-size: 0.8rem;
    }
    
    .unified-table th,
    .unified-table td {
        padding: 0.5rem;
    }
}

@media (max-width: 576px) {
    .unified-table {
        font-size: 0.75rem;
    }
    
    .badge {
        font-size: 0.65rem;
    }
    
    .col-lg-6 {
        flex: 0 0 100%;
        max-width: 100%;
    }
}
</style>

{{ daily_sales_labels|json_script:"daily-sales-labels" }}
{{ daily_sales_values|json_script:"daily-sales-values" }}
{{ payment_labels|json_script:"payment-labels" }}
{{ payment_values|json_script:"payment-values" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Live clock for admin
    function updateAdminClock() {
        const timeEl = document.getElementById('admin-current-time');
        if (!timeEl) return;
        const now = new Date();
        timeEl.textContent = now.toLocaleTimeString();
    }
    updateAdminClock();
    setInterval(updateAdminClock, 1000);

    // Charts
    const salesLabels = JSON.parse(document.getElementById('daily-sales-labels').textContent || '[]');
    const salesValues = JSON.parse(document.getElementById('daily-sales-values').textContent || '[]');
    const paymentLabels = JSON.parse(document.getElementById('payment-labels').textContent || '[]');
    const paymentValues = JSON.parse(document.getElementById('payment-values').textContent || '[]');

    const salesCtx = document.getElementById('dailySalesChart');
    if (salesCtx && salesLabels && salesLabels.length > 0) {
        new Chart(salesCtx, {
            type: 'bar',
            data: {
                labels: salesLabels,
                datasets: [{
                    label: 'Sales (₱)',
                    data: salesValues,
                    backgroundColor: 'rgba(139, 69, 19, 0.6)',
                    borderColor: 'rgba(139, 69, 19, 1)',
                    borderWidth: 1,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: { 
                    legend: { display: false },
                    tooltip: { enabled: true }
                },
                scales: {
                    y: { 
                        beginAtZero: true,
                        ticks: { callback: function(value) { return '₱' + value.toFixed(0); } }
                    }
                }
            }
        });
    }

    const paymentCtx = document.getElementById('paymentMethodChart');
    if (paymentCtx && paymentLabels && paymentLabels.length > 0) {
        new Chart(paymentCtx, {
            type: 'pie',
            data: {
                labels: paymentLabels,
                datasets: [{
                    data: paymentValues,
                    backgroundColor: [
                        'rgba(40, 167, 69, 0.8)',
                        'rgba(13, 110, 253, 0.8)',
                        'rgba(255, 193, 7, 0.8)',
                        'rgba(111, 66, 193, 0.8)'
                    ],
                    borderColor: [
                        'rgba(40, 167, 69, 1)',
                        'rgba(13, 110, 253, 1)',
                        'rgba(255, 193, 7, 1)',
                        'rgba(111, 66, 193, 1)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: { 
                    legend: { position: 'bottom' },
                    tooltip: { 
                        callbacks: {
                            label: function(context) {
                                return context.label + ': ₱' + context.parsed.toFixed(2);
                            }
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}
